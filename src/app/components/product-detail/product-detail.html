<!-- Spinner de carga -->
<app-spinner [show]="isLoading" [message]="'Cargando producto...'"></app-spinner>

<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <button 
      (click)="goBack()" 
      class="inline-flex items-center gap-2 text-blue-900 hover:text-red-600 transition-colors duration-300 font-semibold btn-back-home"
    >
      <i class="fas fa-arrow-left text-lg"></i>
      Volver
    </button>
  </div>

  <!-- SKELETON LOADING STATE (Oculto, ahora usamos spinner) -->
  <div *ngIf="false" class="max-w-7xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Image skeleton -->
      <div class="bg-gray-300 rounded-lg h-96 lg:h-full animate-pulse"></div>

      <!-- Info skeleton -->
      <div class="space-y-6">
        <div class="h-8 bg-gray-300 rounded w-3/4 animate-pulse"></div>
        <div class="h-6 bg-gray-300 rounded w-1/2 animate-pulse"></div>
        <div class="h-5 bg-gray-300 rounded w-2/3 animate-pulse"></div>

        <!-- Description skeleton -->
        <div class="space-y-3 pt-4">
          <div class="h-5 bg-gray-300 rounded w-1/4 animate-pulse"></div>
          <div class="h-4 bg-gray-300 rounded animate-pulse"></div>
          <div class="h-4 bg-gray-300 rounded animate-pulse"></div>
          <div class="h-4 bg-gray-300 rounded w-3/4 animate-pulse"></div>
        </div>

        <!-- Entrepreneur skeleton -->
        <div class="border-t pt-6 space-y-3">
          <div class="h-5 bg-gray-300 rounded w-1/4 animate-pulse"></div>
          <div class="h-4 bg-gray-300 rounded w-1/2 animate-pulse"></div>
          <div class="h-4 bg-gray-300 rounded animate-pulse"></div>
          <div class="h-4 bg-gray-300 rounded w-2/3 animate-pulse"></div>
        </div>

        <!-- Buttons skeleton -->
        <div class="grid grid-cols-2 gap-3 pt-6">
          <div class="h-11 bg-gray-300 rounded animate-pulse"></div>
          <div class="h-11 bg-gray-300 rounded animate-pulse"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADED STATE -->
  <div *ngIf="!isLoading && product" class="detail-container">
    <div class="detail-wrapper">
      <!-- Columna Izquierda: Imagen + Descripción -->
      <div class="detail-main">
        <!-- Card de Imagen -->
        <div class="product-image-card">
          <div class="image-container">
            <img 
              [src]="product.img" 
              [alt]="product.title"
              (load)="onImageLoad(product.img)"
              (error)="onImageError(product.img)"
              class="product-image"
            />
            <div 
              *ngIf="!loadedImages[product.img]" 
              class="image-placeholder"
            >
              <i class="fas fa-image"></i>
              <p>No se pudo cargar la imagen</p>
            </div>
          </div>
          
          <!-- Título y Precio - Solo visible en mobile -->
          <div class="product-header-mobile">
            <h1 class="product-title-mobile">{{ product.title }}</h1>
            <div class="mobile-price-category">
              <div class="product-price">{{ formatPrice(product.price || 0) }}</div>
              <span *ngIf="product.nameCategory" class="category-badge">{{ product.nameCategory }}</span>
            </div>
            <div class="product-location-mobile">
              <i class="fas fa-map-marker-alt"></i>
              <span>{{ product.location || 'Ubicación no disponible' }}</span>
            </div>
          </div>
        </div>

        <!-- Descripción del Producto -->
        <div *ngIf="product.descriptionProduct" class="description-card">
          <div class="card-header">
            <i class="fas fa-align-left"></i>
            <h3>Descripción del Producto</h3>
          </div>
          <div class="description-content">
            <p class="description-text">{{ product.descriptionProduct }}</p>
          </div>
        </div>
      </div>

      <!-- Columna Derecha: Info del Producto + Emprendedor + Botones -->
      <div class="detail-sidebar">
        <!-- Título y Precio - Solo visible en desktop -->
        <div class="product-info-card desktop-only">
          <h1 class="product-title-desktop">{{ product.title }}</h1>
          <div class="product-price-desktop">{{ formatPrice(product.price || 0) }}</div>
          <div class="product-location-desktop">
            <i class="fas fa-map-marker-alt"></i>
            <span>{{ product.location || 'Ubicación no disponible' }}</span>
          </div>
          <div *ngIf="product.nameCategory" class="category-badge-desktop">
            <i class="fas fa-tag"></i> {{ product.nameCategory }}
          </div>
        </div>

        <!-- Información del Emprendedor -->
        <div class="entrepreneur-card">
          <div class="card-header">
            <i class="fas fa-user-tie"></i>
            <h3>Emprendedor</h3>
          </div>
          
          <div class="entrepreneur-content">
            <div class="entrepreneur-name">
              <p class="label">Nombre</p>
              <p class="value">{{ product.firstName }} {{ product.lastName }}</p>
            </div>

            <div *ngIf="product.nameStore" class="entrepreneur-store">
              <p class="label">Tienda</p>
              <p class="value">{{ product.nameStore }}</p>
            </div>

            <!-- Sección expandible de historia -->
            <div *ngIf="product.descriptionStore" class="entrepreneur-story">
              <button 
                class="story-toggle"
                (click)="toggleStoryExpanded()"
                [class.expanded]="showFullStory"
              >
                <i class="fas" [ngClass]="showFullStory ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                <span>{{ showFullStory ? 'Ver menos' : 'Ver más' }}</span>
              </button>
              
              <div class="story-content" [class.show]="showFullStory">
                <p class="label">Mi Historia</p>
                <p class="story-text">{{ product.descriptionStore }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Botones de Acción -->
        <div class="action-buttons">
          <button 
            (click)="contactWhatsApp()"
            class="btn btn-whatsapp"
          >
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
          </button>
          <button 
            (click)="openShareModal()"
            class="btn btn-share"
          >
            <i class="fas fa-share-alt"></i>
            <span>Compartir</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ERROR STATE -->
  <div *ngIf="!isLoading && !product" class="detail-container">
    <div class="error-card">
      <div class="error-icon">
        <i class="fas fa-shopping-bag"></i>
      </div>
      <h3 class="error-title">Producto no encontrado</h3>
      <p class="error-message">El producto que buscas no está disponible o no existe.</p>
      <button 
        (click)="goBack()"
        class="btn-back-home"
      >
        <i class="fas fa-arrow-left"></i>
        Volver a productos
      </button>
    </div>
  </div>

  <!-- SHARE MODAL -->
  <div 
    *ngIf="showShareModal && product" 
    class="share-modal-overlay"
    (click)="closeShareModal()"
  >
    <div 
      class="share-modal"
      (click)="$event.stopPropagation()"
    >
      <!-- Modal Header -->
      <div class="modal-header-share">
        <h2>Compartir Producto</h2>
        <button 
          (click)="closeShareModal()"
          class="btn-modal-close"
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body-share">
        <!-- Product Preview -->
        <div class="modal-product-preview">
          <img 
            [src]="product.img" 
            [alt]="product.title"
            class="modal-product-image"
          />
          <div class="modal-product-info">
            <h3 class="modal-product-title">{{ product.title }}</h3>
            <p class="modal-product-price">{{ formatPrice(product.price) }}</p>
            <p class="modal-product-seller">
              Emprendedor: <strong>{{ product.firstName }} {{ product.lastName }}</strong>
            </p>
          </div>
        </div>

        <!-- Share Link -->
        <div class="modal-share-link">
          <label>Link para compartir:</label>
          <div class="share-link-container">
            <input 
              type="text" 
              [value]="shareLink" 
              readonly
              class="share-link-input"
            />
            <button 
              (click)="copyLink()"
              class="btn btn-copy"
            >
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <!-- Share Actions -->
        <div class="modal-share-actions">
          <button 
            (click)="contactWhatsApp()"
            class="btn btn-whatsapp"
          >
            <i class="fab fa-whatsapp"></i>
            Compartir por WhatsApp
          </button>
          <button 
            (click)="closeShareModal()"
            class="btn btn-close-modal"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

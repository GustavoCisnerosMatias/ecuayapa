<div class="wrap">
  <!-- Spinner de carga -->
  <app-spinner [show]="loading" [message]="'Obteniendo tu ubicaci√≥n...'"></app-spinner>

  <!-- Panel principal -->
  <div class="panel active">

    <div class="panel-header">
      <div class="panel-title">
        <h2>Selecciona tu ubicaci√≥n</h2>
        <div class="muted">Puedes mover el mapa o elegir un punto.</div>
      </div>
    </div>

    <div class="map-and-info">
      <!-- Contenedor del mapa -->
      <div class="map-container">
        <div #mapContainer class="map"></div>

        <!-- Bot√≥n "Cambiar ubicaci√≥n" - Siempre visible sobre el mapa -->
        <button class="btn-change-location-overlay" 
                (click)="activateChangeLocationMode()" 
                [class.active]="changeLocationMode"
                *ngIf="pointSelected"
                [title]="changeLocationMode ? 'Haz clic en el mapa para cambiar' : 'Activar modo cambiar ubicaci√≥n'">
          <i class="fa-solid fa-map-pin"></i>
          <span class="change-location-text">{{ changeLocationMode ? 'Selecciona en el mapa' : 'Cambiar ubicaci√≥n' }}</span>
        </button>
      </div>

      <!-- Panel lateral de informaci√≥n -->
      <div class="info">
        <div class="glass">

          <!-- Control de rango del c√≠rculo -->
          <div class="range-control">
            <label>Rango de b√∫squeda: <strong>{{ circleRadius }} km</strong></label>
            <input type="range" min="3" max="100" [(ngModel)]="circleRadius" (input)="updateCircleRadius()" class="slider">
            <div class="range-labels">
              <span>3 km</span>
              <span>100 km</span>
            </div>
          </div>

          <!-- Lista de ubicaciones cercanas -->
          <div class="nearby-list">
            <div class="nearby-header">
              <h4><i class="fas fa-store"></i> Emprendimientos cercanos ({{ filteredLocations.length }})</h4>
            </div>

            <!-- Buscador y filtros -->
            <div class="search-filter-bar">
              <div class="search-input-wrapper">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input 
                  type="text" 
                  [(ngModel)]="searchQuery" 
                  (input)="filterLocations()"
                  placeholder="Buscar..."
                  class="search-input">
              </div>
              <button class="btn-filters" (click)="toggleFilterModal()" title="Agregar filtros">
                <i class="fa-solid fa-sliders"></i>
              </button>
            </div>

            <!-- Contenedor scrolleable para items -->
            <div class="nearby-items-scroll">
              <!-- Lista filtrada de emprendimientos -->
              <div class="location-item" *ngFor="let loc of filteredLocations" (click)="openLocationModal(loc)">
                <div class="location-marker">
                  <i class="fas fa-shopping-basket"></i>
                </div>
                <div class="location-info">
                  <p class="location-name">{{ loc.title }}</p>
                  <p class="location-seller" *ngIf="loc.seller_name">
                    <i class="fas fa-user"></i> {{ loc.seller_name }}
                  </p>
                  <p class="location-type">{{ loc.category_name }}</p>
                  <p class="location-distance">üìç {{ loc.distance }}</p>
                </div>
                <div class="location-price">
                  {{ formatPrice(loc.price) }}
                </div>
              </div>

              <!-- Mensaje si no hay resultados -->
              <div class="no-results" *ngIf="filteredLocations.length === 0">
                <i class="fas fa-search"></i>
                <p>No hay emprendimientos en este rango</p>
                <small>Prueba aumentando el radio de b√∫squeda</small>
              </div>
            </div>

          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE DETALLES DEL PRODUCTO -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeLocationModal()">
    <div class="modal-content product-modal" *ngIf="selectedLocation" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-header-info">
          <h3>{{ selectedLocation.title }}</h3>
          <span class="modal-category-badge">{{ selectedLocation.category_name }}</span>
        </div>
        <button class="btn-close" (click)="closeLocationModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <!-- Informaci√≥n del vendedor -->
        <div class="seller-info-card">
          <div class="seller-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="seller-details">
            <p class="seller-name">{{ selectedLocation.seller_name || 'Emprendedor' }}</p>
            <p class="seller-location"><i class="fas fa-map-marker-alt"></i> {{ selectedLocation.seller_province || 'Ecuador' }}</p>
          </div>
        </div>

        <!-- Descripci√≥n del producto -->
        <div class="modal-section description-section">
          <label><i class="fas fa-align-left"></i> Descripci√≥n</label>
          <p class="description-text">{{ selectedLocation.description || 'Sin descripci√≥n disponible' }}</p>
        </div>
        
        <!-- Precio y distancia -->
        <div class="modal-info-grid">
          <div class="info-card price-card">
            <i class="fas fa-tag"></i>
            <div class="info-content">
              <span class="info-label">Precio</span>
              <span class="info-value price-value">{{ formatPrice(selectedLocation.price) }}</span>
            </div>
          </div>
          <div class="info-card distance-card">
            <i class="fas fa-route"></i>
            <div class="info-content">
              <span class="info-label">Distancia</span>
              <span class="info-value">{{ selectedLocation.distance }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn primary" (click)="viewProduct(selectedLocation.id_product)">
          <i class="fas fa-eye"></i> Ver Detalles
        </button>
        <button class="btn secondary" (click)="viewLocationOnMap(selectedLocation)">
          <i class="fas fa-map-marked-alt"></i> Ver en Mapa
        </button>
        <button class="btn tertiary" (click)="closeLocationModal()">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
 <div class="modal-overlay" *ngIf="showFilterModal" (click)="toggleFilterModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Filtros</h3>
        <button class="btn-close" (click)="toggleFilterModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <!-- Filtro por Categor√≠a -->
        <div class="modal-section">
          <label><strong>Categor√≠as</strong></label>
          <div class="filter-options">
            <div class="filter-option" *ngFor="let category of availableCategories">
              <input 
                type="checkbox" 
                [id]="'cat-' + category"
                [checked]="selectedCategories.has(category)"
                (change)="toggleCategory(category)">
              <label [for]="'cat-' + category">{{ category }}</label>
            </div>
          </div>
        </div>
        <!-- Filtro por Rango de Precio -->
        <div class="modal-section">
          <label><strong>Rango de Precio: ${{ priceRange.min }} - ${{ priceRange.max }}</strong></label>
          <div class="price-range-inputs">
            <input 
              type="number" 
              [(ngModel)]="priceRange.min" 
              (change)="filterLocations()"
              placeholder="M√≠n"
              class="price-input">
            <span class="price-separator">-</span>
            <input 
              type="number" 
              [(ngModel)]="priceRange.max" 
              (change)="filterLocations()"
              placeholder="M√°x"
              class="price-input">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary" (click)="resetFilters()">Limpiar filtros</button>
        <button class="btn primary" (click)="toggleFilterModal()">Aplicar</button>
      </div>
    </div>
  </div>


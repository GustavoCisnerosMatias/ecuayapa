<!-- Spinner de carga -->
<app-spinner [show]="isLoading" [message]="'Cargando productos...'"></app-spinner>

<section class="products-section">
  <div class="products-container">

    <!-- Botón Volver (solo en vista grid) -->
    <button *ngIf="currentView === 'grid'" class="btn-back-home" (click)="backToHome()">
      <i class="fas fa-arrow-left"></i>
      <span>Volver al inicio</span>
    </button>

    <div class="products-toolbar">
      <div class="products-counter">
        <span class="counter-pill">
          <i class="fas fa-box-open"></i>
          <span *ngIf="currentView === 'home'">{{ allProducts.length }} productos disponibles</span>
          <span *ngIf="currentView === 'grid'">{{ products.length }} productos encontrados</span>
          <span *ngIf="selectedProvinceName"> en {{selectedProvinceName}}</span>
        </span>
      </div>

      <button class="btn-filters" (click)="toggleFilters()">
        <i class="fas fa-filter"></i>
        <span>Filtros</span>
      </button>
    </div>

    <!-- Panel de Filtros -->
    <div class="filters-panel" [class.show]="showFilters">
      <div class="filters-header">
        <h3><i class="fas fa-sliders-h"></i> Filtros de Búsqueda</h3>
        <button class="btn-clear-filters" (click)="clearFilters()">
          <i class="fas fa-times-circle"></i> Limpiar
        </button>
      </div>

      <div class="filters-content">
        <!-- Columna Izquierda: Título y Precios -->
        <div class="filters-column">
          <!-- Búsqueda por título -->
          <div class="filter-group">
            <label><i class="fas fa-search"></i> Buscar por título</label>
            <input 
              type="text" 
              class="filter-input" 
              placeholder="Ej: Carteras, Pijamas..."
              [(ngModel)]="filters.searchText"
              (input)="applyFilters()"
            />
          </div>

          <!-- Filtro de precios -->
          <div class="filter-group">
            <label><i class="fas fa-dollar-sign"></i> Rango de precios</label>
            <div class="price-inputs">
              <input 
                type="number" 
                class="filter-input" 
                placeholder="Mínimo"
                [(ngModel)]="filters.minPrice"
                (input)="applyFilters()"
                min="0"
              />
              <span class="price-separator">-</span>
              <input 
                type="number" 
                class="filter-input" 
                placeholder="Máximo"
                [(ngModel)]="filters.maxPrice"
                (input)="applyFilters()"
                min="0"
              />
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Categorías -->
        <div class="filters-column">
          <div class="filter-group filter-group-full">
            <label><i class="fas fa-tags"></i> Categorías</label>
            <div class="categories-list">
              <button 
                *ngFor="let category of availableCategories"
                class="category-chip"
                [class.active]="filters.selectedCategories.includes(category)"
                (click)="toggleCategory(category)"
              >
                {{ category }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

<!-- ========== VISTA HOME: SECCIONES POR CATEGORÍA ========== -->
<div *ngIf="currentView === 'home' && !isLoading" class="home-view">
  
  <!-- Categorías con productos -->
  <div *ngFor="let group of categoryGroups; let idx = index" class="category-section">
    <div class="category-header">
      <h2 class="category-title">
        <i class="fas fa-th-large"></i>
        {{ group.category }}
        <span class="category-count">({{ group.products.length }})</span>
      </h2>
      <button class="btn-view-all" (click)="viewAllCategory(group.category)">
        Ver más <i class="fas fa-arrow-right"></i>
      </button>
    </div>

    <div class="category-scroll-wrapper">
      <button class="scroll-btn scroll-left" (click)="scrollCategoryLeft(idx)">
        <i class="fas fa-chevron-left"></i>
      </button>

      <div class="category-products-horizontal category-scroll-{{idx}}">
        <article
          class="product-card-horizontal"
          *ngFor="let product of group.products"
          [class.featured]="product.featured"
          (click)="viewProduct(product.id_product)">

          <div class="product-badge-horizontal" *ngIf="product.featured">
            <i class="fas fa-crown"></i>
          </div>

          <div class="product-image-horizontal">
            <img
              [src]="product.img"
              [alt]="product.title"
              (error)="onImageError($event)"
              (load)="onImageLoad($event)"
              crossorigin="anonymous"
            />
            <div class="image-fallback">
              <i class="fas fa-shopping-bag"></i>
            </div>
          </div>

          <div class="product-info-horizontal">
            <h3 class="product-title-horizontal">{{ product.title }}</h3>
            <div class="product-location-horizontal">
              <i class="fas fa-map-marker-alt"></i>
              <span>{{ product.location }}</span>
            </div>
            <div class="product-price-horizontal">{{ formatPrice(product.price) }}</div>
            <div class="product-vendor-horizontal">
              <i class="fas fa-store"></i>
              <span>{{ product.nameStore || (product.firstName + ' ' + product.lastName) }}</span>
            </div>
          </div>
        </article>
      </div>

      <button class="scroll-btn scroll-right" (click)="scrollCategoryRight(idx)">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="!isLoading && categoryGroups.length === 0" class="empty-state">
    <div class="empty-icon">
      <i class="fas fa-shopping-bag"></i>
    </div>
    <h3>No hay productos disponibles</h3>
    <p>Actualmente no hay productos. ¡Vuelve pronto para ver nuevas ofertas!</p>
  </div>
</div>

<!-- ========== VISTA GRID: TODOS LOS PRODUCTOS ========== -->
<div *ngIf="currentView === 'grid'" class="products-grid">

  <!-- Placeholder cards mientras carga -->
  <ng-container *ngIf="products.length === 0">
    <!-- Mensaje cuando no hay productos -->
    <div class="empty-state" *ngIf="!isLoading">
      <div class="empty-icon">
        <i class="fas fa-shopping-bag"></i>
      </div>
      <h3>No hay productos disponibles</h3>
      <p>Actualmente no hay productos en esta ubicación. ¡Vuelve pronto para ver nuevas ofertas!</p>
    </div>
    
    <!-- Solo 3 skeleton cards para loading -->
    <article class="product-card placeholder" *ngFor="let i of [1,2,3]" [style.display]="isLoading ? 'block' : 'none'">
      <div class="product-card-glow"></div>

      <div class="product-image skeleton-box"></div>

      <div class="product-info">
        <div class="product-header">
          <h3 class="product-title skeleton-text"></h3>
          <span class="product-chip-category skeleton-text" style="width: 80px; height: 24px;"></span>
        </div>
        <div class="product-specs">
          <div class="spec skeleton-text"></div>
          <div class="spec skeleton-text"></div>
        </div>
        <div class="product-footer">
          <div class="product-price skeleton-text" style="width: 80px; height: 28px;"></div>
          <div class="product-actions">
            <div class="skeleton-button" style="width: 42px; height: 42px; border-radius: 0.6rem;"></div>
            <div class="skeleton-button" style="width: 42px; height: 42px; border-radius: 0.6rem;"></div>
          </div>
        </div>
      </div>
    </article>
  </ng-container>

  <!-- Productos reales -->
  <article
    class="product-card"
    *ngFor="let product of paginatedProducts"
    [class.featured]="product.featured">

    <div class="product-card-glow"></div>

    <div class="product-badge" *ngIf="product.featured">
      <i class="fas fa-crown"></i>
      Destacado
    </div>

    <div class="product-image">
      <img
        [src]="product.img"
        [alt]="product.title"
        (error)="onImageError($event)"
        (load)="onImageLoad($event)"
        crossorigin="anonymous"
      />
      <div class="image-fallback">
        <i class="fas fa-shopping-bag"></i>
      </div>
      <!-- <div class="product-overlay">
        <button class="btn-view" (click)="viewProduct(product.id_product)">
          <i class="fas fa-eye"></i> Ver detalles
        </button>
        <button class="btn-contact" (click)="viewProduct(product.id_product)">
          <i class="fas fa-comment-alt"></i> Estoy interesado
        </button>
      </div> -->
    </div>

    <div class="product-info">
      <div class="product-header">
        <h3 class="product-title">{{ product.title }}</h3>
        <span class="product-chip-category" *ngIf="product.nameCategory">
          <i class="fas fa-tag"></i> {{ product.nameCategory }}
        </span>
      </div>

      <div class="product-specs">
        <div class="spec spec-location">
          <i class="fas fa-map-marker-alt"></i>
          <span class="scrollable-location">{{ product.location }}</span>
        </div>
        <div class="spec spec-vendor">
          <i class="fas fa-store"></i>
          <span class="scrollable-vendor">{{ product.nameStore || (product.firstName + ' ' + product.lastName) }}</span>
        </div>
      </div>

      <div class="product-footer">
        <div class="product-price">{{ formatPrice(product.price) }}</div>
        <div class="product-actions">
          <button class="btn-action btn-view" (click)="viewProduct(product.id_product)" title="Ver detalles">
            <i class="fas fa-eye"></i>
            <span class="btn-text">Ver detalles</span>
          </button>
          <!-- <button class="btn-action btn-interested" (click)="viewProduct(product.id_product)" title="Estoy interesado">
            <i class="fas fa-shopping-cart"></i>
            <span class="btn-text">Interesado</span>
          </button> -->
        </div>
      </div>
    </div>

  </article>
</div>

<!-- Paginación (solo en vista grid) -->
<div class="pagination-container" *ngIf="currentView === 'grid' && products.length > 0 && !isLoading">
  <div class="pagination-info">
    <span>Mostrando {{ (currentPage - 1) * productsPerPage + 1 }} - {{ Math.min(currentPage * productsPerPage, products.length) }} de {{ products.length }} productos</span>
  </div>
  
  <div class="pagination-controls">
    <button 
      class="pagination-btn pagination-prev" 
      (click)="prevPage()" 
      [disabled]="currentPage === 1"
      [class.disabled]="currentPage === 1">
      <i class="fas fa-chevron-left"></i>
      Anterior
    </button>

    <div class="pagination-numbers">
      <button 
        *ngFor="let page of getPageNumbers()"
        [class.pagination-number]="page !== -1"
        [class.pagination-ellipsis]="page === -1"
        [class.active]="page === currentPage"
        [disabled]="page === -1"
        (click)="page !== -1 && goToPage(page)">
        {{ page === -1 ? '...' : page }}
      </button>
    </div>

    <button 
      class="pagination-btn pagination-next" 
      (click)="nextPage()" 
      [disabled]="currentPage === totalPages"
      [class.disabled]="currentPage === totalPages">
      Siguiente
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</div>

  </div>
</section>

<!-- Spinner de carga -->
<app-spinner [show]="isLoading" [message]="'Cargando productos...'"></app-spinner>

<section class="products-section" (click)="closeDropdownOnClickOutside($event)">
  <div class="products-container">

    <!-- Botón Volver (solo en vista grid) -->
    <button *ngIf="currentView === 'grid'" class="btn-back-home" (click)="backToHome()">
      <i class="fas fa-arrow-left"></i>
      <span>Volver</span>
    </button>

    <!-- Header con ubicación y contador -->
    <div class="products-header-bar">
      <!-- Selector de ubicación -->
      <div class="location-selector" [class.open]="showProvinceDropdown">
        <button class="location-btn" (click)="toggleProvinceDropdown()">
          <i class="fas fa-map-marker-alt"></i>
          <span class="location-text">{{ selectedProvinceName }}</span>
          <i class="fas fa-chevron-down chevron-icon"></i>
        </button>
        
        <!-- Dropdown de provincias -->
        <div class="province-dropdown" *ngIf="showProvinceDropdown">
          <div class="dropdown-header">
            <span>Seleccionar Provincia</span>
            <button class="btn-all-ecuador" (click)="clearProvinceFilter()">
              <!-- <i class="fas fa-globe-americas"></i>Ecuador -->
               Ecuador
               <img src="assets/pilares1.png" class="ecuador-flag"/>
            </button>
          </div>

          <!-- Buscador de provincias -->
          <div class="province-search-box">
            <input type="text" [(ngModel)]="provinceSearch" placeholder="Buscar provincia..." class="province-search-input" />
            <i class="fas fa-search search-icon"></i>
          </div>

          <div class="provinces-list">
            <button 
              *ngFor="let province of filteredProvinces; trackBy: trackByProvinceId"
              class="province-item"
              [class.active]="selectedProvince === province.name"
              (click)="selectProvince(province)">
              <i class="fas fa-map-pin"></i>
              {{ province.name }}
            </button>
          </div>
        </div>
      </div>

      <!-- Contador y filtros -->
      <div class="header-right">
        <span class="counter-pill">
          <i class="fas fa-box-open"></i>
          <span *ngIf="currentView === 'home'">{{ allProducts.length }} productos</span>
          <span *ngIf="currentView === 'grid'">{{ products.length }} productos</span>
        </span>
        
        <button class="btn-filters" (click)="toggleFilters()">
          <i class="fas fa-sliders-h"></i>
          <span>Filtros</span>
        </button>
      </div>
    </div>

    <!-- Navegación rápida de categorías principales -->
    <div class="main-categories-nav" *ngIf="currentView === 'home'">
      <button 
        *ngFor="let category of mainCategories; trackBy: trackByIndex"
        class="category-nav-btn"
        (click)="scrollToCategory(category.name_category)">
        <i class="fas" [ngClass]="getCategoryIcon(category.id_category)"></i>
        <span>{{ category.name_category }}</span>
      </button>
    </div>

    <!-- Panel de Filtros -->
    <div class="filters-panel" [class.show]="showFilters">
      <div class="filters-header">
        <h3><i class="fas fa-sliders-h"></i> Filtros de Búsqueda</h3>
        <button class="btn-clear-filters" (click)="clearFilters()">
          <i class="fas fa-times-circle"></i> Limpiar
        </button>
      </div>

      <div class="filters-content">
        <!-- Columna 1: Búsqueda por producto (70%) -->
        <div class="filters-column">
          <div class="filter-group">
            <label><i class="fas fa-search"></i> Buscar por producto</label>
            <input 
              type="text" 
              class="filter-input" 
              placeholder="Ej: Carteras, Pijamas..."
              [(ngModel)]="filters.searchText"
              (input)="applyFilters()"
            />
          </div>
        </div>

        <!-- Columna 2: Rango de precios (30%) -->
        <div class="filters-column">
          <div class="filter-group">
            <label><i class="fas fa-dollar-sign"></i> Rango de precios</label>
            <div class="price-inputs">
              <input 
                type="number" 
                class="filter-input" 
                placeholder="Mín"
                [(ngModel)]="filters.minPrice"
                (input)="applyFilters()"
                min="0"
              />
              <span class="price-separator">-</span>
              <input 
                type="number" 
                class="filter-input" 
                placeholder="Máx"
                [(ngModel)]="filters.maxPrice"
                (input)="applyFilters()"
                min="0"
              />
            </div>
          </div>
        </div>
      </div>
    </div>

<!-- ========== VISTA HOME: SECCIONES POR CATEGORÍA ========== -->
<div *ngIf="currentView === 'home' && !isLoading" class="home-view">
  
  <!-- Categorías con productos -->
  <div *ngFor="let group of categoryGroups; let idx = index; trackBy: trackByCategoryIndex" class="category-section">
    <div class="category-header">
      <h2 class="category-title">
        <i class="fas fa-th-large"></i>
        {{ group.category }}
        <span class="category-count">({{ group.products.length }})</span>
      </h2>
      <button class="btn-view-all" (click)="viewAllCategory(group.category)">
        Ver más <i class="fas fa-arrow-right"></i>
      </button>
    </div>

    <div class="category-scroll-wrapper">
      <button class="scroll-btn scroll-left" (click)="scrollCategoryLeft(idx)">
        <i class="fas fa-chevron-left"></i>
      </button>

      <div class="category-products-horizontal category-scroll-{{idx}}">
        <article
          class="product-card-horizontal"
          *ngFor="let product of group.products; trackBy: trackByProductId"
          [class.featured]="product.featured"
          (click)="viewProduct(product.id_product)">

          <div class="product-card-glow"></div>

          <div class="product-badge" *ngIf="product.featured">
            <i class="fas fa-crown"></i>
            Destacado
          </div>

          <div class="product-image">
            <img
              [src]="product.img"
              [alt]="product.title"
              (error)="onImageError($event)"
              (load)="onImageLoad($event)"
              crossorigin="anonymous"
            />
            <div class="image-fallback">
              <i class="fas fa-shopping-bag"></i>
            </div>
          </div>

          <div class="product-info">
            <div class="product-header">
              <h3 class="product-title">{{ product.title }}</h3>

            </div>

            <div class="product-specs">
              <div class="spec spec-location">
                <i class="fas fa-map-marker-alt"></i>
                <div class="text-scroll-container">
                  <span class="scroll-text">{{ product.location }}</span>
                </div>
              </div>
              <div class="spec spec-vendor">
                <i class="fas fa-store"></i>
                <div class="text-scroll-container">
                  <span class="scroll-text">{{ product.nameStore || (product.firstName + ' ' + product.lastName) }}</span>
                </div>
              </div>
            </div>

            <div class="product-footer">
              <div class="product-price">{{ formatPrice(product.price) }}</div>
              <div class="product-actions">
                <button class="btn-action btn-view" (click)="viewProduct(product.id_product); $event.stopPropagation()" title="Ver detalles">
                  <i class="fas fa-eye"></i>
                  <span class="btn-text">Ver detalles</span>
                </button>
              </div>
            </div>
          </div>
        </article>
      </div>

      <button class="scroll-btn scroll-right" (click)="scrollCategoryRight(idx)">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="!isLoading && categoryGroups.length === 0" class="empty-state">
    <div class="empty-icon">
      <i class="fas fa-shopping-bag"></i>
    </div>
    <h3>No hay productos disponibles</h3>
    <p>Actualmente no hay productos. ¡Vuelve pronto para ver nuevas ofertas!</p>
  </div>
</div>

<!-- ========== VISTA GRID: TODOS LOS PRODUCTOS ========== -->
<div *ngIf="currentView === 'grid'" class="products-grid">

  <!-- Filtro de subcategorías (solo si hay categoría seleccionada y subcategorías disponibles) -->
  <div *ngIf="selectedCategoryView && availableSubcategories.length > 0" class="subcategories-filter">
    <div class="subcategories-container">
      <button 
        class="subcategory-btn"
        [class.active]="selectedSubcategory === null"
        (click)="filterBySubcategory(null)">
        Todas
      </button>
      <button 
        *ngFor="let subcat of availableSubcategories; trackBy: trackByIndex"
        class="subcategory-btn"
        [class.active]="selectedSubcategory === subcat"
        (click)="filterBySubcategory(subcat)">
        {{ subcat }}
      </button>
    </div>
  </div>

  <!-- Placeholder cards mientras carga -->
  <ng-container *ngIf="products.length === 0">
    <!-- Mensaje cuando no hay productos -->
    <div class="empty-state" *ngIf="!isLoading">
      <div class="empty-icon">
        <i class="fas fa-shopping-bag"></i>
      </div>
      <h3>No hay productos disponibles</h3>
      <p>Actualmente no hay productos en esta ubicación. ¡Vuelve pronto para ver nuevas ofertas!</p>
    </div>
    
    <!-- Solo 3 skeleton cards para loading -->
    <article class="product-card placeholder" *ngFor="let i of [1,2,3,4,5]" [style.display]="isLoading ? 'block' : 'none'">
      <div class="product-card-glow"></div>

      <div class="product-image skeleton-box"></div>

      <div class="product-info">
        <div class="product-header">
          <h3 class="product-title skeleton-text"></h3>
          <span class="product-chip-category skeleton-text" style="width: 80px; height: 24px;"></span>
        </div>
        <div class="product-specs">
          <div class="spec skeleton-text"></div>
          <div class="spec skeleton-text"></div>
        </div>
        <div class="product-footer">
          <div class="product-price skeleton-text" style="width: 80px; height: 28px;"></div>
          <div class="product-actions">
            <div class="skeleton-button" style="width: 42px; height: 42px; border-radius: 0.6rem;"></div>
            <div class="skeleton-button" style="width: 42px; height: 42px; border-radius: 0.6rem;"></div>
          </div>
        </div>
      </div>
    </article>
  </ng-container>

  <!-- Productos reales -->
  <article
    class="product-card"
    *ngFor="let product of paginatedProducts; trackBy: trackByProductId"
    [class.featured]="product.featured">

    <div class="product-card-glow"></div>

    <div class="product-badge" *ngIf="product.featured">
      <i class="fas fa-crown"></i>
      Destacado
    </div>

    <div class="product-image">
      <img
        [src]="product.img"
        [alt]="product.title"
        (error)="onImageError($event)"
        (load)="onImageLoad($event)"
        crossorigin="anonymous"
      />
      <div class="image-fallback">
        <i class="fas fa-shopping-bag"></i>
      </div>
    </div>

    <div class="product-info">
      <div class="product-header">
        <h3 class="product-title">{{ product.title }}</h3>

      </div>

      <div class="product-specs">
        <div class="spec spec-location">
          <i class="fas fa-map-marker-alt"></i>
          <div class="text-scroll-container">
            <span class="scroll-text">{{ product.location }}</span>
          </div>
        </div>
        <div class="spec spec-vendor">
          <i class="fas fa-store"></i>
          <div class="text-scroll-container">
            <span class="scroll-text">{{ product.nameStore || (product.firstName + ' ' + product.lastName) }}</span>
          </div>
        </div>
      </div>

      <div class="product-footer">
        <div class="product-price">{{ formatPrice(product.price) }}</div>
        <div class="product-actions">
          <button class="btn-action btn-view" (click)="viewProduct(product.id_product)" title="Ver detalles">
            <i class="fas fa-eye"></i>
            <span class="btn-text">Ver detalles</span>
          </button>

        </div>
      </div>
    </div>

  </article>
</div>

<!-- Paginación (solo en vista grid) -->
<div class="pagination-container" *ngIf="currentView === 'grid' && products.length > 0 && !isLoading">
  <div class="pagination-info">
    <span>Mostrando {{ (currentPage - 1) * productsPerPage + 1 }} - {{ Math.min(currentPage * productsPerPage, products.length) }} de {{ products.length }} productos</span>
  </div>
  
  <div class="pagination-controls">
    <button 
      class="pagination-btn pagination-prev" 
      (click)="prevPage()" 
      [disabled]="currentPage === 1"
      [class.disabled]="currentPage === 1">
      <i class="fas fa-chevron-left"></i>
      Anterior
    </button>

    <div class="pagination-numbers">
      <button 
        *ngFor="let page of getPageNumbers(); trackBy: trackByPageNumber"
        [class.pagination-number]="page !== -1"
        [class.pagination-ellipsis]="page === -1"
        [class.active]="page === currentPage"
        [disabled]="page === -1"
        (click)="page !== -1 && goToPage(page)">
        {{ page === -1 ? '...' : page }}
      </button>
    </div>

    <button 
      class="pagination-btn pagination-next" 
      (click)="nextPage()" 
      [disabled]="currentPage === totalPages"
      [class.disabled]="currentPage === totalPages">
      Siguiente
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</div>

<!-- Botón flotante Ir Arriba -->
<!-- <button *ngIf="showScrollTop" class="scroll-to-top-btn" (click)="scrollToTop()" aria-label="Ir arriba" title="Ir arriba">
  <i class="fas fa-arrow-up"></i>
</button> -->

  </div>
</section>
